{% extends 'schools/base.html' %}
{% load static %}
{% load school_filters %}
{% load humanize %}

{% block title %}Assessments{% endblock %}

{% block extra_css %}
<style>
    /* Header Background Styles */
    .page-header {
        position: relative;
        overflow: hidden;
        z-index: 1;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #2937f0 0%, #9f1ae2 100%) !important;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='rgba(255,255,255,0.05)' fill-rule='evenodd'/%3E%3C/svg%3E"),
            linear-gradient(135deg, rgba(41, 55, 240, 0.95) 0%, rgba(159, 26, 226, 0.95) 100%);
        background-size: 40px 40px, 100% 100%;
        opacity: 1;
        z-index: -1;
    }

    .page-header::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%);
        transform: rotate(30deg);
        z-index: -1;
    }

    .card.bg-gradient-primary {
        box-shadow: 0 10px 20px rgba(41, 55, 240, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Enhanced Page Header -->
    <div class="position-relative mb-5">
        <!-- Background Header Card -->
        <div class="card bg-gradient-primary border-0 rounded-3 shadow-sm">
            <div class="card-body px-4 py-5">
                <div class="row align-items-center">
                    <!-- Header Title and Breadcrumb -->
                    <div class="col-lg-6 col-md-8">
                        <div class="d-flex align-items-center mb-3">
                            <div class="position-relative me-3">
                                <div class="bg-white bg-opacity-25 rounded-circle p-2">
                                    <i class="bi bi-journal-check text-white fs-4"></i>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-white mb-1">Assessment Management</h3>
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb mb-0">
                                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}" class="text-white text-opacity-75">Dashboard</a></li>
                                        <li class="breadcrumb-item active text-white" aria-current="page">Assessments</li>
                                    </ol>
                                </nav>
                            </div>
                        </div>
                        <p class="text-white text-opacity-75 mb-0">
                            Track and manage student assessments. Record grades, monitor progress, and analyze performance across subjects and terms.
                        </p>
                    </div>
                    <!-- Action Buttons -->
                    <div class="col-lg-6 col-md-4">
                        <div class="d-flex gap-2 justify-content-md-end mt-3 mt-md-0">
                            <a href="{% url 'assessment_create' %}" class="btn btn-light px-3 shadow-sm">
                                <i class="bi bi-plus-lg me-2"></i>New Assessment
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Decorative Shape -->
            <div class="position-absolute end-0 bottom-0 me-4 mb-4 d-none d-lg-block">
                <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="60" cy="60" r="60" fill="white" fill-opacity="0.1"/>
                    <path d="M80 40H40V80H80V40Z" stroke="white" stroke-opacity="0.2" stroke-width="2"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <!-- Total Assessments -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-box bg-soft-primary">
                            <i class="bi bi-journal-check text-primary"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-muted small mb-1">Total Assessments</p>
                            <div class="d-flex align-items-baseline">
                                <h3 class="mb-0">{{ total_assessments|default:0|intcomma }}</h3>
                                {% if recent_assessments %}
                                <small class="text-success ms-2">
                                    <i class="bi bi-plus-circle"></i>
                                    {{ recent_assessments }} new
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Average Performance -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-box bg-soft-success">
                            <i class="bi bi-graph-up text-success"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-muted small mb-1">Average Performance</p>
                            <div class="d-flex align-items-center">
                                <h3 class="mb-0">{{ avg_performance }}%</h3>
                                <div class="progress ms-2" style="width: 60px; height: 4px;">
                                    <div class="progress-bar bg-success" style="width: {{ avg_performance }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Assessed -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-box bg-soft-info">
                            <i class="bi bi-people text-info"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-muted small mb-1">Students Assessed</p>
                            <h3 class="mb-0">{{ students_assessed|default:0|intcomma }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Term Progress -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon-box bg-soft-warning">
                            <i class="bi bi-calendar-check text-warning"></i>
                        </div>
                        <div class="ms-3">
                            <p class="text-muted small mb-1">Term {{ current_term }} Assessments</p>
                            <h3 class="mb-0">{{ assessments_this_term|default:0|intcomma }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Term</label>
                    <select name="term" class="form-select">
                        <option value="all">All Terms</option>
                        {% for term in terms %}
                        <option value="{{ term }}" {% if filters.term == term|stringformat:"s" %}selected{% endif %}>
                            Term {{ term }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Assessment Type</label>
                    <select name="type" class="form-select">
                        <option value="all">All Types</option>
                        {% for type_code, type_name in assessment_types %}
                        <option value="{{ type_code }}" {% if filters.type == type_code %}selected{% endif %}>
                            {{ type_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Grade</label>
                    <select name="grade" class="form-select">
                        <option value="all">All Grades</option>
                        {% for grade in grades %}
                        <option value="{{ grade.id }}" {% if filters.grade == grade.id|stringformat:"s" %}selected{% endif %}>
                            {{ grade.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel me-2"></i>Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Students List -->
    {% regroup students by grade as grade_list %}
    {% for grade in grade_list %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <h6 class="mb-0">{{ grade.grouper.name }}</h6>
            <a href="?grade={{ grade.grouper.id }}" class="btn btn-sm btn-outline-primary">
                View All
                <span class="badge bg-primary ms-2">{{ grade.list|length }}</span>
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Latest Assessment</th>
                            <th>Term</th>
                            <th>Performance</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in grade.list|slice:":3" %}
                        {% with latest_assessment=student.recent_assessments|first %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if student.photo %}
                                    <div class="avatar-circle me-3">
                                        <img src="{{ student.photo.url }}" 
                                             alt="{{ student.get_full_name }}" 
                                             class="rounded-circle"
                                             width="40" height="40">
                                    </div>
                                    {% else %}
                                    <div class="avatar-circle bg-soft-primary text-primary me-3" 
                                         style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                        {{ student.first_name|make_list|first }}{{ student.last_name|make_list|first }}
                                    </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-0">{{ student.first_name }} {{ student.last_name }}</h6>
                                        <small class="text-muted">Adm: {{ student.admission_number }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if latest_assessment %}
                                <div class="d-flex flex-column">
                                    <span class="badge bg-{{ latest_assessment.assessment_type|assessment_type_color }}-soft mb-1">
                                        {{ latest_assessment.get_assessment_type_display }}
                                    </span>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        {{ latest_assessment.date|date:"M d, Y" }}
                                    </small>
                                </div>
                                {% else %}
                                <span class="text-muted">No assessments yet</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if latest_assessment %}
                                <span class="badge bg-light fw-medium text-dark">
                                    <i class="bi bi-bookmark me-1"></i>
                                    Term {{ latest_assessment.term }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if latest_assessment %}
                                {% with result=latest_assessment.results.first %}
                                {% if result %}
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                        <div class="progress-bar bg-{{ result.performance_level|floatformat:0|performance_color }}"
                                             style="width: {{ result.performance_level|floatformat:0 }}%">
                                        </div>
                                    </div>
                                    <span class="badge bg-{{ result.performance_level|floatformat:0|performance_color }}-soft">
                                        {{ result.performance_level|floatformat:1 }}%
                                    </span>
                                </div>
                                {% else %}
                                <span class="text-muted">No results</span>
                                {% endif %}
                                {% endwith %}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <div class="btn-group">
                                    <a href="{% url 'student_detail' student.id %}#academics" 
                                       class="btn btn-light btn-sm" 
                                       data-bs-toggle="tooltip" 
                                       title="View Academic History">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'student_detail' student.id %}?action=new_assessment#academics" 
                                       class="btn btn-primary btn-sm" 
                                       data-bs-toggle="tooltip" 
                                       title="Record New Assessment">
                                        <i class="bi bi-plus-lg"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="card">
        <div class="card-body text-center py-5">
            <div class="text-muted">
                <i class="bi bi-inbox display-6 mb-3 d-block"></i>
                <p class="mb-3">No students found matching the filters.</p>
                <a href="{% url 'assessment_create' %}" class="btn btn-primary rounded-pill px-4">
                    <i class="bi bi-plus-lg me-2"></i>Record Assessment
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %} 
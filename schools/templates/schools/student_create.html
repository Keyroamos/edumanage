{% extends 'schools/base.html' %}
{% load widget_tweaks %}
{% load humanize %}

{% block extra_css %}
<style>
    .profile-placeholder {
        width: 120px;
        height: 120px;
        background: #f8f9fa;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #adb5bd;
    }

    /* Add loading spinner styles */
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }

    /* Add preview image styles */
    .profile-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        display: none;
    }

    /* Add validation styles */
    .form-control.is-invalid:focus,
    .form-select.is-invalid:focus {
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }

    /* Grade selection styles */
    .grade-select-wrapper {
        position: relative;
    }

    .grade-select-wrapper .form-select {
        padding-right: 2.5rem;
    }

    .grade-info {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 0.25rem;
        z-index: 1000;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .grade-select-wrapper:hover .grade-info {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="card bg-primary-subtle border-0 mb-4">
        <div class="card-body py-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-1 text-primary">New Student Registration</h4>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}"
                                    class="text-decoration-none">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'student_list' %}"
                                    class="text-decoration-none">Students</a></li>
                            <li class="breadcrumb-item active">Register</li>
                        </ol>
                    </nav>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <a href="{% url 'student_list' %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left me-2"></i>Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Form -->
        <div class="col-lg-8">
            <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}

                <!-- Student Photo Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-camera me-2 text-warning"></i>Student Photo
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div class="profile-photo-wrapper mb-3">
                                <div class="profile-placeholder rounded-circle">
                                    <i class="bi bi-person display-4"></i>
                                </div>
                                <img id="photoPreview" class="profile-preview" alt="Profile preview">
                            </div>
                            <input type="file" name="photo" id="id_photo" class="d-none" accept="image/*"
                                data-max-size="2">
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="document.getElementById('id_photo').click()">
                                <i class="bi bi-camera me-2"></i>Upload Photo
                            </button>
                            <small class="d-block text-muted mt-2">Optional: Upload a student photo (max 2MB)</small>
                            <div id="photoError" class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>

                <!-- Basic Information Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-person-vcard me-2 text-primary"></i>Basic Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Admission Number *</label>
                                {% render_field form.admission_number class="form-control" placeholder="Enter admission
                                number" %}
                                <small class="form-text text-muted">Leave blank to auto-generate. This will be the
                                    student's username.</small>
                                {% if form.admission_number.errors %}
                                <div class="invalid-feedback d-block">{{ form.admission_number.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Birth Certificate No.</label>
                                {% render_field form.birth_certificate_no class="form-control" placeholder="Enter birth
                                certificate number" %}
                                {% if form.birth_certificate_no.errors %}
                                <div class="invalid-feedback d-block">{{ form.birth_certificate_no.errors|join:", " }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">First Name *</label>
                                {% render_field form.first_name class="form-control" placeholder="Enter first name" %}
                                {% if form.first_name.errors %}
                                <div class="invalid-feedback d-block">{{ form.first_name.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name *</label>
                                {% render_field form.last_name class="form-control" placeholder="Enter last name" %}
                                {% if form.last_name.errors %}
                                <div class="invalid-feedback d-block">{{ form.last_name.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Gender *</label>
                                {% render_field form.gender class="form-select" %}
                                {% if form.gender.errors %}
                                <div class="invalid-feedback d-block">{{ form.gender.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date of Birth *</label>
                                {% render_field form.date_of_birth class="form-control" type="date" %}
                                {% if form.date_of_birth.errors %}
                                <div class="invalid-feedback d-block">{{ form.date_of_birth.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-building me-2 text-primary"></i>School Location * <span
                                        class="text-danger">(Required)</span>
                                </label>
                                {% render_field form.location class="form-select" required="required" %}
                                {% if form.location.errors %}
                                <div class="invalid-feedback d-block">{{ form.location.errors|join:", " }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Select Main School or Annex School
                                </small>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Academic Information Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-mortarboard me-2 text-success"></i>Academic Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Grade *</label>
                                <div class="grade-select-wrapper">
                                    <select name="grade" class="form-select" required>
                                        <option value="">Select Grade</option>

                                        <optgroup label="Early Years">
                                            {% for grade in grades %}
                                            {% if grade.name == 'PG' %}
                                            <option value="{{ grade.id }}" data-fees="{{ grade.term_fees }}">
                                                Playgroup
                                            </option>
                                            {% endif %}
                                            {% endfor %}
                                        </optgroup>

                                        <optgroup label="Pre-Primary">
                                            {% for grade in grades %}
                                            {% if grade.name == 'PP1' or grade.name == 'PP2' %}
                                            <option value="{{ grade.id }}" data-fees="{{ grade.term_fees }}">
                                                {{ grade.get_name_display }}
                                            </option>
                                            {% endif %}
                                            {% endfor %}
                                        </optgroup>

                                        <optgroup label="Primary School">
                                            {% for grade in grades %}
                                            {% if grade.name|slice:":1" == 'G' %}
                                            <option value="{{ grade.id }}" data-fees="{{ grade.term_fees }}">
                                                {{ grade.get_name_display }}
                                            </option>
                                            {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                    </select>
                                    <div class="grade-info">
                                        <p class="mb-1"><strong>Term Fees:</strong> <span id="gradeFees">-</span></p>
                                        <p class="mb-0"><small class="text-muted">Select a grade to see details</small>
                                        </p>
                                    </div>
                                </div>
                                {% if form.grade.errors %}
                                <div class="invalid-feedback d-block">{{ form.grade.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Current Term *</label>
                                {% render_field form.current_term class="form-select" %}
                                {% if form.current_term.errors %}
                                <div class="invalid-feedback d-block">{{ form.current_term.errors|join:", " }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Academic Year *</label>
                                {% render_field form.academic_year class="form-select" %}
                                {% if form.academic_year.errors %}
                                <div class="invalid-feedback d-block">{{ form.academic_year.errors|join:", " }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parent Information Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white py-3">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-person me-2 text-info"></i>Parent Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>Fill in parent information (optional - at least one parent or guardian is
                                required)</small>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Parent Name</label>
                                {% render_field form.parent_name class="form-control" placeholder="Enter parent name" %}
                                <-- {% if form.parent_name.errors %} <div class="invalid-feedback d-block">{{
                                    form.parent_name.errors|join:", " }}
                            </div>
                            {% endif %} --!>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone Number</label>
                            {% render_field form.parent_phone class="form-control" placeholder="Enter phone number" %}
                            {% if form.parent_phone.errors %}
                            <div class="invalid-feedback d-block">{{ form.parent_phone.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email Address</label>
                            {% render_field form.parent_email class="form-control" placeholder="Enter email address" %}
                            {% if form.parent_email.errors %}
                            <div class="invalid-feedback d-block">{{ form.parent_email.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Occupation/Profession</label>
                            {% render_field form.parent_occupation class="form-control" placeholder="Enter occupation or
                            profession" %}
                            {% if form.parent_occupation.errors %}
                            <div class="invalid-feedback d-block">{{ form.parent_occupation.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ID Number</label>
                            {% render_field form.parent_id_number class="form-control" placeholder="Enter parent ID
                            number" %}
                            {% if form.parent_id_number.errors %}
                            <div class="invalid-feedback d-block">{{ form.parent_id_number.errors|join:", " }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
        </div>

        <!-- Guardian Information Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="card-title mb-0">
                    <i class="bi bi-shield-check me-2 text-success"></i>Guardian Information
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <small>Fill in guardian information (optional - at least one parent or guardian is required)</small>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Guardian Name</label>
                        {% render_field form.guardian_name class="form-control" placeholder="Enter guardian name" %}
                        {% if form.guardian_name.errors %}
                        <div class="invalid-feedback d-block">{{ form.guardian_name.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone Number</label>
                        {% render_field form.guardian_phone class="form-control" placeholder="Enter phone number" %}
                        {% if form.guardian_phone.errors %}
                        <div class="invalid-feedback d-block">{{ form.guardian_phone.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email Address</label>
                        {% render_field form.guardian_email class="form-control" placeholder="Enter email address" %}
                        {% if form.guardian_email.errors %}
                        <div class="invalid-feedback d-block">{{ form.guardian_email.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Occupation/Profession</label>
                        {% render_field form.guardian_occupation class="form-control" placeholder="Enter occupation or
                        profession" %}
                        {% if form.guardian_occupation.errors %}
                        <div class="invalid-feedback d-block">{{ form.guardian_occupation.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ID Number</label>
                        {% render_field form.guardian_id_number class="form-control" placeholder="Enter guardian ID
                        number" %}
                        {% if form.guardian_id_number.errors %}
                        <div class="invalid-feedback d-block">{{ form.guardian_id_number.errors|join:", " }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>



        <!-- Admission Fee Notice -->
        <div class="card shadow-sm mb-4 border-warning">
            <div class="card-body">
                <div class="alert alert-warning mb-0">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                        <div>
                            <strong>Admission Fee Required:</strong> An admission fee of <strong>KES {{
                                admission_fee|floatformat:0|intcomma }}</strong> must be paid before the student can be
                            registered in the system.
                            <br><small class="text-muted">You will be prompted to confirm payment after submitting this
                                form.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">* Required fields</small>
                    <div class="d-flex gap-2">
                        <a href="{% url 'student_list' %}" class="btn btn-light">Cancel</a>
                        <button type="submit" class="btn btn-primary px-4" id="submitBtn">
                            <span class="normal-state">
                                <i class="bi bi-person-plus me-2"></i>Continue to Payment
                            </span>
                            <span class="loading-state d-none">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Processing...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </form>
    </div>

    <!-- Help Section -->
    <div class="col-lg-4">
        <div class="card shadow-sm border-0 bg-light sticky-top" style="top: 1rem;">
            <div class="card-body">
                <h5 class="card-title d-flex align-items-center mb-4">
                    <i class="bi bi-info-circle text-primary me-2"></i>
                    Registration Guide
                </h5>

                <div class="mb-4">
                    <h6 class="fw-bold text-primary mb-3">Required Information</h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2"><i class="bi bi-check2-circle text-success me-2"></i>Student's full name</li>
                        <li class="mb-2"><i class="bi bi-check2-circle text-success me-2"></i>Admission number</li>
                        <li class="mb-2"><i class="bi bi-check2-circle text-success me-2"></i>Gender</li>
                        <li class="mb-2"><i class="bi bi-check2-circle text-success me-2"></i>Grade assignment</li>
                        <li class="mb-2"><i class="bi bi-check2-circle text-success me-2"></i>Current term</li>
                        <li class="mb-2"><i class="bi bi-check2-circle text-success me-2"></i>Parent details</li>
                    </ul>
                </div>

                <div>
                    <h6 class="fw-bold text-primary mb-3">Tips</h6>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item bg-transparent px-0">
                            <i class="bi bi-1-circle me-2"></i>
                            Double-check the admission number
                        </div>
                        <div class="list-group-item bg-transparent px-0">
                            <i class="bi bi-2-circle me-2"></i>
                            Verify parent contact information
                        </div>
                        <div class="list-group-item bg-transparent px-0">
                            <i class="bi bi-3-circle me-2"></i>
                            Ensure correct grade selection
                        </div>
                        <div class="list-group-item bg-transparent px-0">
                            <i class="bi bi-4-circle me-2"></i>
                            Confirm current term
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const photoInput = document.getElementById('id_photo');
        const photoPreview = document.getElementById('photoPreview');
        const placeholder = document.querySelector('.profile-placeholder');
        const photoError = document.getElementById('photoError');
        const submitBtn = document.getElementById('submitBtn');
        const gradeSelect = document.querySelector('select[name="grade"]');
        const gradeFeesSpan = document.getElementById('gradeFees');

        // Photo preview
        photoInput.addEventListener('change', function (e) {
            const file = this.files[0];
            if (file) {
                // Validate file size (2MB)
                if (file.size > 2 * 1024 * 1024) {
                    photoError.textContent = 'Photo size must be less than 2MB';
                    photoError.style.display = 'block';
                    this.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    placeholder.style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        });

        // Grade fees display
        gradeSelect.addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const fees = selectedOption.dataset.fees;
            gradeFeesSpan.textContent = fees ? `KES ${parseFloat(fees).toLocaleString()}` : '-';
        });

        // Form submission
        form.addEventListener('submit', function (e) {
            if (!this.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
            } else {
                submitBtn.disabled = true;
                submitBtn.querySelector('.normal-state').classList.add('d-none');
                submitBtn.querySelector('.loading-state').classList.remove('d-none');
            }
            this.classList.add('was-validated');
        });
    });
</script>
{% endblock %}
{% endblock %}
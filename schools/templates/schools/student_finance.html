{% extends 'schools/base.html' %}
{% load static %}
{% load school_filters %}
{% load humanize %}

{% block title %}{{ student.get_full_name }} - Finance{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --primary-light: #3b82f6;
        --success: #10b981;
        --success-light: #34d399;
        --danger: #ef4444;
        --danger-light: #f87171;
        --warning: #f59e0b;
        --warning-light: #fbbf24;
        --info: #06b6d4;
        --info-light: #22d3ee;
        --purple: #8b5cf6;
        --purple-light: #a78bfa;
        
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --bg-card: #ffffff;
        --bg-card-dark: #1e293b;
        --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --bg-gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        --bg-gradient-danger: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        --bg-gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        --bg-gradient-info: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%);
        --bg-gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        
        --text-primary: #0f172a;
        --text-secondary: #64748b;
        --text-tertiary: #94a3b8;
        --text-white: #ffffff;
        
        --border-color: #e2e8f0;
        --border-radius: 20px;
        --border-radius-sm: 12px;
        --border-radius-lg: 24px;
        
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-colored: 0 10px 30px -10px rgba(37, 99, 235, 0.3);
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
    }

    /* Modern Header */
    .finance-header {
        background: var(--bg-gradient);
        border-radius: var(--border-radius);
        padding: 1.5rem 1.75rem;
        margin-bottom: 1.5rem;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-xl);
    }

    .finance-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 500px;
        height: 500px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        filter: blur(60px);
    }

    .finance-header::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -5%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 50%;
        filter: blur(50px);
    }

    .finance-header-content {
        position: relative;
        z-index: 2;
    }

    .finance-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        letter-spacing: -0.02em;
    }

    .finance-header .subtitle {
        font-size: 0.9rem;
        opacity: 0.95;
        font-weight: 400;
    }

    .breadcrumb-modern {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.8rem;
        opacity: 0.9;
    }

    .breadcrumb-modern a {
        color: white;
        text-decoration: none;
        transition: opacity 0.2s;
    }

    .breadcrumb-modern a:hover {
        opacity: 0.8;
    }

    /* Health Score Card - Premium Design */
    .health-score-wrapper {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .health-score-wrapper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--bg-gradient-success);
    }

    .health-score-circle-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 1rem 0;
    }

    .health-score-circle {
        width: 140px;
        height: 140px;
        position: relative;
    }

    .health-score-inner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 2;
    }

    .health-score-value {
        font-size: 2.25rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .health-score-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    /* Premium Summary Cards */
    .summary-card-modern {
        background: white;
        border-radius: var(--border-radius-sm);
        padding: 1.25rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .summary-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--bg-gradient);
    }

    .summary-card-modern:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-xl);
    }

    .summary-card-modern.total-fees::before {
        background: var(--bg-gradient);
    }

    .summary-card-modern.total-paid::before {
        background: var(--bg-gradient-success);
    }

    .summary-card-modern.balance::before {
        background: var(--bg-gradient-danger);
    }

    .summary-card-modern.progress::before {
        background: var(--bg-gradient-info);
    }

    .summary-card-modern.ytd::before {
        background: var(--bg-gradient-warning);
    }

    .summary-card-modern.recent::before {
        background: var(--bg-gradient-purple);
    }

    .summary-card-header-modern {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .summary-icon-modern {
        width: 48px;
        height: 48px;
        border-radius: var(--border-radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
        box-shadow: var(--shadow-md);
    }

    .summary-icon-modern.total-fees {
        background: var(--bg-gradient);
    }

    .summary-icon-modern.total-paid {
        background: var(--bg-gradient-success);
    }

    .summary-icon-modern.balance {
        background: var(--bg-gradient-danger);
    }

    .summary-icon-modern.progress {
        background: var(--bg-gradient-info);
    }

    .summary-icon-modern.ytd {
        background: var(--bg-gradient-warning);
    }

    .summary-icon-modern.recent {
        background: var(--bg-gradient-purple);
    }

    .summary-label-modern {
        font-size: 0.7rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .summary-value-modern {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        line-height: 1.2;
        letter-spacing: -0.02em;
    }

    .summary-subtext-modern {
        font-size: 0.8rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-top: 0.5rem;
    }

    .summary-badge-modern {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-top: 0.75rem;
    }

    .summary-badge-modern.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .summary-badge-modern.warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .summary-badge-modern.danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    .summary-badge-modern.info {
        background: rgba(6, 182, 212, 0.1);
        color: var(--info);
    }

    /* Modern Progress Bar */
    .progress-modern-wrapper {
        margin-top: 1.5rem;
    }

    .progress-modern {
        height: 12px;
        border-radius: 50px;
        background: #f1f5f9;
        overflow: hidden;
        position: relative;
    }

    .progress-bar-modern {
        height: 100%;
        border-radius: 50px;
        background: var(--bg-gradient-success);
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .progress-bar-modern::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Section Cards */
    .section-card-modern {
        background: white;
        border-radius: var(--border-radius-sm);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 1.5rem;
    }

    .section-header-modern {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f1f5f9;
    }

    .section-title-modern {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title-modern i {
        font-size: 1.35rem;
        background: var(--bg-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Chart Container */
    .chart-container-modern {
        position: relative;
        height: 280px;
        margin-top: 1rem;
    }

    .chart-container-large {
        height: 320px;
    }

    /* Stats Grid */
    .stats-grid-modern {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.25rem;
        margin-top: 2rem;
    }

    .stat-item-modern {
        text-align: center;
        padding: 1rem;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .stat-item-modern:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .stat-value-modern {
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .stat-label-modern {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Premium Payment Table */
    .payment-table-modern {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .payment-table-modern thead {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .payment-table-modern thead th {
        padding: 0.875rem 1rem;
        font-weight: 700;
        color: var(--text-primary);
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
        border: none;
        text-align: left;
    }

    .payment-table-modern thead th:first-child {
        border-top-left-radius: var(--border-radius-sm);
    }

    .payment-table-modern thead th:last-child {
        border-top-right-radius: var(--border-radius-sm);
    }

    .payment-table-modern tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #f1f5f9;
    }

    .payment-table-modern tbody tr:hover {
        background: #f8fafc;
        transform: scale(1.01);
    }

    .payment-table-modern tbody tr:last-child {
        border-bottom: none;
    }

    .payment-table-modern tbody td {
        padding: 1rem;
        vertical-align: middle;
        font-size: 0.9rem;
    }

    .payment-method-badge-modern {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        border: 1px solid;
    }

    .payment-method-badge-modern.cash {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border-color: rgba(16, 185, 129, 0.2);
    }

    .payment-method-badge-modern.mpesa {
        background: rgba(6, 182, 212, 0.1);
        color: var(--info);
        border-color: rgba(6, 182, 212, 0.2);
    }

    .payment-method-badge-modern.bank {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary);
        border-color: rgba(37, 99, 235, 0.2);
    }

    .status-badge-modern {
        padding: 0.4rem 0.75rem;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        border: 1px solid;
    }

    .status-badge-modern.completed {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border-color: rgba(16, 185, 129, 0.2);
    }

    .status-badge-modern.pending {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
        border-color: rgba(245, 158, 11, 0.2);
    }

    .status-badge-modern.failed {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
        border-color: rgba(239, 68, 68, 0.2);
    }

    /* Empty State */
    .empty-state-modern {
        text-align: center;
        padding: 2.5rem 1.5rem;
        color: var(--text-secondary);
    }

    .empty-state-modern i {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        opacity: 0.3;
        background: var(--bg-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .empty-state-modern h5 {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    /* Action Buttons */
    .btn-modern {
        padding: 0.5rem 1.25rem;
        border-radius: var(--border-radius-sm);
        font-weight: 600;
        font-size: 0.875rem;
        border: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        text-decoration: none;
    }

    .btn-modern-primary {
        background: var(--bg-gradient);
        color: white;
        box-shadow: var(--shadow-colored);
    }

    .btn-modern-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
        color: white;
    }

    .btn-modern-light {
        background: white;
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-modern-light:hover {
        background: #f8fafc;
        transform: translateY(-2px);
        color: var(--text-primary);
    }

    .action-btn-modern {
        padding: 0.5rem;
        border-radius: var(--border-radius-sm);
        border: none;
        background: transparent;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }

    .action-btn-modern.view {
        color: var(--primary);
    }

    .action-btn-modern.view:hover {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary);
    }

    .action-btn-modern.print {
        color: var(--purple);
    }

    .action-btn-modern.print:hover {
        background: rgba(139, 92, 246, 0.1);
        color: var(--purple);
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .slide-in {
        animation: slideIn 0.5s ease-out;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .finance-header {
            padding: 2rem 1.5rem;
        }

        .finance-header h1 {
            font-size: 1.75rem;
        }

        .summary-card-modern {
            padding: 1.5rem;
        }

        .section-card-modern {
            padding: 1.5rem;
        }

        .chart-container-modern {
            height: 250px;
        }

        .stats-grid-modern {
            grid-template-columns: repeat(2, 1fr);
        }

        .payment-table-modern {
            font-size: 0.875rem;
        }

        .payment-table-modern thead th,
        .payment-table-modern tbody td {
            padding: 1rem 0.75rem;
        }
    }

    /* Utility Classes */
    .text-gradient {
        background: var(--bg-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .text-success-modern {
        color: var(--success);
    }

    .text-danger-modern {
        color: var(--danger);
    }

    .text-warning-modern {
        color: var(--warning);
    }

    .text-info-modern {
        color: var(--info);
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Modern Finance Header -->
    <div class="finance-header fade-in-up">
        <div class="finance-header-content">
            <div class="breadcrumb-modern">
                        {% if user.is_superuser %}
                        <a href="{% url 'dashboard' %}">
                            <i class="bi bi-house"></i> Dashboard
                        </a>
                        <i class="bi bi-chevron-right"></i>
                        {% endif %}
                <a href="{% url 'student_detail' student.pk %}">Student Profile</a>
                        <i class="bi bi-chevron-right"></i>
                        <span>Finance</span>
                    </div>
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <h1>
                        <i class="bi bi-wallet2 me-3"></i>
                        Financial Dashboard
                    </h1>
                    <p class="subtitle mb-0">{{ student.get_full_name }} â€¢ {{ student.admission_number }}</p>
                </div>
                <div class="d-flex gap-2">
                    {% if user|is_accountant %}
                    <button type="button" class="btn-modern btn-modern-light" data-bs-toggle="modal" data-bs-target="#recordPaymentModal">
                        <i class="bi bi-plus-circle"></i>Record Payment
                    </button>
                    {% endif %}
                    <a href="{% url 'student_detail' student.pk %}" class="btn-modern btn-modern-light">
                        <i class="bi bi-arrow-left"></i>Back to Profile
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Score & Trends Row -->
    <div class="row mb-4">
        <div class="col-lg-4 mb-4 mb-lg-0">
            <div class="health-score-wrapper fade-in-up">
                <h5 class="mb-2" style="font-weight: 700; font-size: 1rem; color: var(--text-primary);">
                    <i class="bi bi-heart-pulse me-2 text-gradient"></i>Financial Health
                </h5>
                <div class="health-score-circle-wrapper">
                <div class="health-score-circle">
                        <svg width="140" height="140" viewBox="0 0 200 200">
                            <circle cx="100" cy="100" r="90" fill="none" stroke="#f1f5f9" stroke-width="12"/>
                            <circle cx="100" cy="100" r="90" fill="none" 
                                    stroke="{% if health_score >= 80 %}#10b981{% elif health_score >= 50 %}#f59e0b{% else %}#ef4444{% endif %}" 
                                    stroke-width="12" 
                                    stroke-dasharray="{{ health_score|mul:5.65 }} 565" 
                                    stroke-dashoffset="141" 
                                    transform="rotate(-90 100 100)"
                                    stroke-linecap="round"/>
                        </svg>
                        <div class="health-score-inner">
                            <div class="health-score-value {% if health_score >= 80 %}text-success-modern{% elif health_score >= 50 %}text-warning-modern{% else %}text-danger-modern{% endif %}">
                                {{ health_score|floatformat:0 }}
                            </div>
                            <div class="health-score-label">Score</div>
                        </div>
                    </div>
                </div>
                <p class="text-center mb-0" style="color: var(--text-secondary); font-size: 0.8rem;">
                    {% if health_score >= 80 %}
                        <i class="bi bi-check-circle-fill text-success-modern me-2"></i>Excellent payment record
                    {% elif health_score >= 50 %}
                        <i class="bi bi-info-circle-fill text-warning-modern me-2"></i>Good payment standing
                    {% else %}
                        <i class="bi bi-exclamation-triangle-fill text-danger-modern me-2"></i>Payment attention needed
                    {% endif %}
                </p>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="section-card-modern fade-in-up">
                <div class="section-header-modern">
                    <h2 class="section-title-modern">
                        <i class="bi bi-graph-up-arrow"></i>
                        Payment Trends
                    </h2>
                </div>
                <div class="chart-container-modern">
                    <canvas id="paymentTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="summary-card-modern total-fees fade-in-up">
                <div class="summary-card-header-modern">
                    <div style="flex: 1;">
                        <div class="summary-label-modern">
                        <i class="bi bi-cash-stack"></i>
                        Total Fees
                    </div>
                        <div class="summary-value-modern">KES {{ total_fees|floatformat:0|intcomma }}</div>
                        <div class="summary-subtext-modern">
                        <i class="bi bi-calendar-range"></i>
                        Annual fee structure
                    </div>
                </div>
                    <div class="summary-icon-modern total-fees">
                    <i class="bi bi-cash-stack"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="summary-card-modern total-paid fade-in-up">
                <div class="summary-card-header-modern">
                    <div style="flex: 1;">
                        <div class="summary-label-modern">
                        <i class="bi bi-check-circle"></i>
                        Total Paid
                    </div>
                        <div class="summary-value-modern text-success-modern">KES {{ total_paid|floatformat:0|intcomma }}</div>
                        <div class="summary-subtext-modern">
                        <i class="bi bi-receipt"></i>
                        {{ payments|length }} payment{{ payments|length|pluralize }} recorded
                    </div>
                    {% if payments|length > 0 %}
                        <span class="summary-badge-modern success">
                        <i class="bi bi-check-circle-fill"></i>
                        Active
                    </span>
                    {% else %}
                        <span class="summary-badge-modern warning">
                        <i class="bi bi-exclamation-circle"></i>
                        No payments yet
                    </span>
                    {% endif %}
                </div>
                    <div class="summary-icon-modern total-paid">
                    <i class="bi bi-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="summary-card-modern balance fade-in-up">
                <div class="summary-card-header-modern">
                    <div style="flex: 1;">
                        <div class="summary-label-modern">
                        <i class="bi bi-wallet2"></i>
                        Outstanding Balance
                    </div>
                        <div class="summary-value-modern {% if balance > 0 %}text-danger-modern{% else %}text-success-modern{% endif %}">
                        KES {{ balance|floatformat:0|intcomma }}
                    </div>
                        <div class="summary-subtext-modern">
                        <i class="bi bi-{% if balance > 0 %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
                        {% if balance > 0 %}Payment required{% else %}Fully paid{% endif %}
                    </div>
                    {% if balance > 0 %}
                        <span class="summary-badge-modern danger">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Action needed
                    </span>
                    {% else %}
                        <span class="summary-badge-modern success">
                        <i class="bi bi-check-circle-fill"></i>
                        Clear
                    </span>
                    {% endif %}
                </div>
                    <div class="summary-icon-modern balance">
                    <i class="bi bi-wallet2"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="summary-card-modern progress fade-in-up">
                <div class="summary-card-header-modern">
                    <div style="flex: 1;">
                        <div class="summary-label-modern">
                        <i class="bi bi-percent"></i>
                        Payment Progress
                    </div>
                        <div class="summary-value-modern text-info-modern">{{ payment_percentage|floatformat:1 }}%</div>
                        <div class="summary-subtext-modern">
                        <i class="bi bi-graph-up"></i>
                        Completion rate
                    </div>
                        <div class="progress-modern-wrapper">
                            <div class="progress-modern">
                        <div class="progress-bar-modern" style="width: {{ payment_percentage }}%"></div>
                            </div>
                    </div>
                    {% if payment_percentage >= 100 %}
                        <span class="summary-badge-modern success mt-2">
                        <i class="bi bi-trophy-fill"></i>
                        Complete
                    </span>
                    {% elif payment_percentage >= 50 %}
                        <span class="summary-badge-modern info mt-2">
                        <i class="bi bi-arrow-up-circle"></i>
                        In progress
                    </span>
                    {% else %}
                        <span class="summary-badge-modern warning mt-2">
                        <i class="bi bi-hourglass-split"></i>
                        Getting started
                    </span>
                    {% endif %}
                </div>
                    <div class="summary-icon-modern progress">
                    <i class="bi bi-percent"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="summary-card-modern ytd fade-in-up">
                <div class="summary-card-header-modern">
                    <div style="flex: 1;">
                        <div class="summary-label-modern">
                        <i class="bi bi-calendar-check"></i>
                        Year to Date
                    </div>
                        <div class="summary-value-modern text-warning-modern">KES {{ ytd_total|floatformat:0|intcomma }}</div>
                        <div class="summary-subtext-modern">
                        <i class="bi bi-calendar3"></i>
                        Payments this year
                    </div>
                    {% if ytd_total > 0 %}
                        <span class="summary-badge-modern success">
                        <i class="bi bi-arrow-up"></i>
                        {{ payments|length }} payment{{ payments|length|pluralize }}
                    </span>
                    {% else %}
                        <span class="summary-badge-modern warning">
                        <i class="bi bi-calendar-x"></i>
                        No payments yet
                    </span>
                    {% endif %}
                </div>
                    <div class="summary-icon-modern ytd">
                    <i class="bi bi-calendar-check"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6">
            <div class="summary-card-modern recent fade-in-up">
                <div class="summary-card-header-modern">
                    <div style="flex: 1;">
                        <div class="summary-label-modern">
                        <i class="bi bi-clock-history"></i>
                        Last 30 Days
                    </div>
                        <div class="summary-value-modern">KES {{ recent_total|floatformat:0|intcomma }}</div>
                        <div class="summary-subtext-modern">
                        <i class="bi bi-{% if last_payment_date %}clock{% else %}clock-history{% endif %}"></i>
                        {% if last_payment_date %}
                            Last payment: {{ last_payment_date|date:"M d, Y" }}
                        {% else %}
                            No recent payments
                        {% endif %}
                    </div>
                    {% if recent_total > 0 %}
                        <span class="summary-badge-modern success">
                        <i class="bi bi-activity"></i>
                        Recent activity
                    </span>
                    {% elif last_payment_date and days_since_last %}
                        <span class="summary-badge-modern warning">
                        <i class="bi bi-hourglass"></i>
                        {{ days_since_last }} days ago
                    </span>
                    {% else %}
                        <span class="summary-badge-modern danger">
                        <i class="bi bi-exclamation-circle"></i>
                        No payments
                    </span>
                    {% endif %}
                </div>
                    <div class="summary-icon-modern recent">
                    <i class="bi bi-clock-history"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Row -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="section-card-modern fade-in-up">
                <div class="section-header-modern">
                    <h2 class="section-title-modern">
                        <i class="bi bi-pie-chart-fill"></i>
                        Payment Methods
                    </h2>
                </div>
                <div class="chart-container-modern">
                    <canvas id="paymentMethodsChart"></canvas>
                </div>
                <div class="stats-grid-modern">
                    {% for method_data in payment_method_data %}
                    <div class="stat-item-modern">
                        <div class="stat-value-modern">KES {{ method_data.amount|floatformat:0|intcomma }}</div>
                        <div class="stat-label-modern">{{ method_data.method }} ({{ method_data.count }})</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="section-card-modern fade-in-up">
                <div class="section-header-modern">
                    <h2 class="section-title-modern">
                        <i class="bi bi-bar-chart-fill"></i>
                        Payment Statistics
                    </h2>
                </div>
                <div class="stats-grid-modern">
                    <div class="stat-item-modern">
                        <div class="stat-value-modern">{{ payments|length }}</div>
                        <div class="stat-label-modern">Total Payments</div>
                    </div>
                    <div class="stat-item-modern">
                        <div class="stat-value-modern">KES {{ avg_payment|floatformat:0|intcomma }}</div>
                        <div class="stat-label-modern">Average Payment</div>
                    </div>
                    <div class="stat-item-modern">
                        <div class="stat-value-modern">KES {{ largest_payment|floatformat:0|intcomma }}</div>
                        <div class="stat-label-modern">Largest Payment</div>
                    </div>
                    <div class="stat-item-modern">
                        <div class="stat-value-modern">{{ payment_frequency|floatformat:1 }}</div>
                        <div class="stat-label-modern">Payments/Month</div>
                    </div>
                    {% if days_since_last %}
                    <div class="stat-item-modern">
                        <div class="stat-value-modern">{{ days_since_last }}</div>
                        <div class="stat-label-modern">Days Since Last</div>
                    </div>
                    {% endif %}
                    <div class="stat-item-modern">
                        <div class="stat-value-modern">
                            {% if status_data.COMPLETED %}{{ status_data.COMPLETED.count }}{% else %}0{% endif %}
                        </div>
                        <div class="stat-label-modern">Completed</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History -->
    <div class="section-card-modern fade-in-up">
        <div class="section-header-modern">
            <h2 class="section-title-modern">
                <i class="bi bi-clock-history"></i>
                Payment History
            </h2>
            {% if user|is_accountant %}
            <button type="button" class="btn-modern btn-modern-primary" data-bs-toggle="modal" data-bs-target="#recordPaymentModal">
                <i class="bi bi-plus-circle"></i>Record Payment
            </button>
            {% endif %}
        </div>
        
        {% if payments %}
        <div class="table-responsive">
            <table class="payment-table-modern">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reference</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Term</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr class="payment-row {% if forloop.counter > 5 %}payment-row-hidden{% endif %}">
                        <td>
                            <div style="font-weight: 600; color: var(--text-primary);">{{ payment.date|date:"M d, Y" }}</div>
                            <small style="color: var(--text-secondary); font-size: 0.875rem;">{{ payment.date|date:"h:i A" }}</small>
                        </td>
                        <td>
                            <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 6px; color: var(--primary); font-size: 0.875rem;">{{ payment.reference_number }}</code>
                        </td>
                        <td>
                            <div style="font-weight: 700; color: var(--success); font-size: 1.1rem;">KES {{ payment.amount|floatformat:2|intcomma }}</div>
                        </td>
                        <td>
                            <span class="payment-method-badge-modern {{ payment.payment_method|lower }}">
                                {% if payment.payment_method == 'CASH' %}
                                    <i class="bi bi-cash"></i>
                                {% elif payment.payment_method == 'MPESA' %}
                                    <i class="bi bi-phone"></i>
                                {% elif payment.payment_method == 'BANK' %}
                                    <i class="bi bi-bank"></i>
                                {% endif %}
                                {{ payment.get_payment_method_display }}
                            </span>
                        </td>
                        <td>
                            <span style="background: #f1f5f9; color: var(--text-primary); padding: 0.35rem 0.75rem; border-radius: 50px; font-size: 0.875rem; font-weight: 600;">Term {{ payment.term }}</span>
                        </td>
                        <td>
                            <span class="status-badge-modern {{ payment.status|lower }}">
                                {% if payment.status == 'COMPLETED' %}
                                    <i class="bi bi-check-circle"></i>
                                {% elif payment.status == 'PENDING' %}
                                    <i class="bi bi-clock"></i>
                                {% else %}
                                    <i class="bi bi-x-circle"></i>
                                {% endif %}
                                {{ payment.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <a href="{% url 'payment_detail' payment.pk %}" class="action-btn-modern view" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if user|is_accountant %}
                                <button class="action-btn-modern print" onclick="window.print()" title="Print Receipt">
                                    <i class="bi bi-printer"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if payments|length > 5 %}
        <div class="text-center mt-4">
            <button type="button" class="btn-modern btn-modern-outline" id="togglePaymentHistory">
                <i class="bi bi-chevron-down" id="togglePaymentIcon"></i>
                <span id="togglePaymentText">View More</span>
            </button>
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state-modern">
            <i class="bi bi-inbox"></i>
            <h5>No Payment Records</h5>
            <p>No payment history available for this student.</p>
            {% if user|is_accountant %}
            <button type="button" class="btn-modern btn-modern-primary mt-3" data-bs-toggle="modal" data-bs-target="#recordPaymentModal">
                <i class="bi bi-plus-circle"></i>Record First Payment
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Record Payment Modal - Shared Template -->
{% url 'student_finance' student.pk as finance_url %}
{% include 'schools/includes/record_payment_modal.html' with student=student redirect_url=finance_url %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Payment Trends Chart - Modern Design
    const trendsCtx = document.getElementById('paymentTrendsChart');
    if (trendsCtx) {
        // Parse JSON data - data is already JSON string from backend
        let monthlyLabels = {{ monthly_labels|safe }};
        let monthlyData = {{ monthly_data|safe }};
        
        // Check if we have data
        const hasData = monthlyData && monthlyData.length > 0 && monthlyData.some(val => val > 0);
        
        if (!hasData) {
            // Show message if no data
            trendsCtx.parentElement.innerHTML = '<div class="text-center p-4 text-muted"><i class="bi bi-graph-up" style="font-size: 3rem; opacity: 0.3;"></i><p class="mt-3">No payment data available for the trend chart</p></div>';
        } else {
            new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Monthly Payments',
                        data: monthlyData,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#2563eb',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3,
                        pointHoverBackgroundColor: '#1e40af',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            padding: 16,
                            titleFont: {
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                size: 13
                            },
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            cornerRadius: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'KES ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KES ' + value.toLocaleString();
                                },
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                color: '#64748b'
                            },
                            grid: {
                                color: 'rgba(226, 232, 240, 0.8)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                color: '#64748b'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    }

    // Payment Methods Chart - Modern Design
    const methodsCtx = document.getElementById('paymentMethodsChart');
    if (methodsCtx) {
        // Parse JSON data
        let paymentMethodLabels = {{ payment_method_labels|safe }};
        let paymentMethodAmounts = {{ payment_method_amounts|safe }};
        
        new Chart(methodsCtx, {
            type: 'doughnut',
            data: {
                labels: paymentMethodLabels,
                datasets: [{
                    data: paymentMethodAmounts,
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.9)',
                        'rgba(6, 182, 212, 0.9)',
                        'rgba(37, 99, 235, 0.9)'
                    ],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            color: '#64748b',
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        padding: 16,
                        titleFont: {
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13
                        },
                        borderColor: '#e2e8f0',
                        borderWidth: 1,
                        cornerRadius: 12,
                        callbacks: {
                            label: function(context) {
                                return context.label + ': KES ' + context.parsed.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Payment History Toggle Functionality
    const togglePaymentHistory = document.getElementById('togglePaymentHistory');
    if (togglePaymentHistory) {
        // Get all payment rows and filter to get only those beyond the first 5
        const allPaymentRows = Array.from(document.querySelectorAll('.payment-row'));
        const paymentRows = allPaymentRows.slice(5); // Get rows starting from index 5
        const toggleIcon = document.getElementById('togglePaymentIcon');
        const toggleText = document.getElementById('togglePaymentText');
        let isExpanded = false;

        togglePaymentHistory.addEventListener('click', function() {
            isExpanded = !isExpanded;
            
            paymentRows.forEach((row, index) => {
                if (isExpanded) {
                    // Show the row by removing the hidden class and inline styles
                    row.classList.remove('payment-row-hidden');
                    row.style.removeProperty('display');
                    // Add fade-in animation with delay
                    setTimeout(() => {
                        row.classList.add('fade-in');
                    }, index * 50);
                } else {
                    // Hide the row by adding the hidden class
                    row.classList.add('payment-row-hidden');
                    row.classList.remove('fade-in');
                    row.style.removeProperty('display');
                }
            });

            if (isExpanded) {
                toggleIcon.classList.remove('bi-chevron-down');
                toggleIcon.classList.add('bi-chevron-up');
                toggleText.textContent = 'Show Less';
            } else {
                toggleIcon.classList.remove('bi-chevron-up');
                toggleIcon.classList.add('bi-chevron-down');
                const hiddenCount = paymentRows.length;
                if (hiddenCount > 0) {
                    toggleText.textContent = `View More (${hiddenCount} more)`;
                } else {
                    toggleText.textContent = 'View More';
                }
            }
        });
    }
});
</script>

<style>
    .payment-row-hidden {
        display: none !important;
    }

    .payment-row.fade-in {
        animation: fadeInRow 0.3s ease-in;
    }

    @keyframes fadeInRow {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .btn-modern-outline {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-modern-outline:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-modern-outline i {
        transition: transform 0.3s ease;
    }

    .btn-modern-outline:hover i {
        transform: translateY(2px);
    }
</style>
{% endblock %}

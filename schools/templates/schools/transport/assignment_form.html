{% extends 'schools/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 pb-0">
                    <h4 class="mb-0">{{ page_title }}</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Student *</label>
                                {{ form.student }}
                                {% if form.student.errors %}
                                    <div class="text-danger small">{{ form.student.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Route *</label>
                                {{ form.route }}
                                {% if form.route.errors %}
                                    <div class="text-danger small">{{ form.route.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Vehicle</label>
                                {{ form.vehicle }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Start Date *</label>
                                {{ form.start_date }}
                                {% if form.start_date.errors %}
                                    <div class="text-danger small">{{ form.start_date.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pickup Location</label>
                                <div class="input-group">
                                {{ form.pickup_location }}
                                    <button type="button" class="btn btn-outline-secondary" onclick="pickLocation('pickup')" title="Pick on map">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </button>
                                </div>
                                {{ form.pickup_latitude }}
                                {{ form.pickup_longitude }}
                                <small class="text-muted">Click the map icon to pick location on map</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Dropoff Location</label>
                                <div class="input-group">
                                {{ form.dropoff_location }}
                                    <button type="button" class="btn btn-outline-secondary" onclick="pickLocation('dropoff')" title="Pick on map">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </button>
                                </div>
                                {{ form.dropoff_latitude }}
                                {{ form.dropoff_longitude }}
                                <small class="text-muted">Click the map icon to pick location on map</small>
                            </div>
                            <div class="col-12">
                                <div id="location-picker-map-container">
                                    <label class="form-label">Location Map</label>
                                    <div id="location-picker-map" style="height: 400px; width: 100%; border-radius: 8px; border: 1px solid #dee2e6;"></div>
                                    <small class="text-muted">Enter an address above and the map will update automatically. Use the map to verify locations.</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pickup Time</label>
                                {{ form.pickup_time }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Dropoff Time</label>
                                {{ form.dropoff_time }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Date</label>
                                {{ form.end_date }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <div class="form-check form-switch mt-2">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        Active
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                {{ form.notes }}
                            </div>
                        </div>
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <a href="{% if assignment %}{% url 'transport_assignment_detail' pk=assignment.pk %}{% else %}{% url 'transport_assignment_list' %}{% endif %}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentField = null;

    // Initialize map with default location on page load
    function initializeMap() {
        const mapDiv = document.getElementById('location-picker-map');
        if (!mapDiv) return;

        // Default to school location
        const defaultLocation = 'Bishop Dr. Mando International School, Jaipur, Rajasthan, India';
        const embedUrl = `https://www.google.com/maps?q=${encodeURIComponent(defaultLocation)}&output=embed`;
        mapDiv.innerHTML = `<iframe width="100%" height="400" style="border:0; border-radius: 8px;" loading="lazy" allowfullscreen="" referrerpolicy="no-referrer-when-downgrade" src="${embedUrl}"></iframe>`;
    }

    function pickLocation(field) {
        currentField = field;
        const mapContainer = document.getElementById('location-picker-map-container');
        if (!mapContainer) {
            return;
        }

        // Get existing coordinates or default to school location
        let lat = null;
        let lng = null;
        let address = '';

        if (field === 'pickup') {
            const latField = document.getElementById('id_pickup_latitude');
            const lngField = document.getElementById('id_pickup_longitude');
            const addressInput = document.getElementById('id_pickup_location');
            if (latField && latField.value) lat = parseFloat(latField.value);
            if (lngField && lngField.value) lng = parseFloat(lngField.value);
            if (addressInput && addressInput.value) address = addressInput.value;
        } else if (field === 'dropoff') {
            const latField = document.getElementById('id_dropoff_latitude');
            const lngField = document.getElementById('id_dropoff_longitude');
            const addressInput = document.getElementById('id_dropoff_location');
            if (latField && latField.value) lat = parseFloat(latField.value);
            if (lngField && lngField.value) lng = parseFloat(lngField.value);
            if (addressInput && addressInput.value) address = addressInput.value;
        }

        // Update embedded map
        const mapDiv = document.getElementById('location-picker-map');
        let query = '';
        
        if (address) {
            query = address;
        } else if (lat && lng) {
            query = `${lat},${lng}`;
        } else {
            // Default to school location
            query = 'Bishop Dr. Mando International School, Jaipur, Rajasthan, India';
        }

        const embedUrl = `https://www.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
        mapDiv.innerHTML = `<iframe width="100%" height="400" style="border:0; border-radius: 8px;" loading="lazy" allowfullscreen="" referrerpolicy="no-referrer-when-downgrade" src="${embedUrl}"></iframe>`;

        // Scroll to map
        mapContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Update map when address input changes
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize map with school location after a short delay to ensure DOM is ready
        setTimeout(function() {
            initializeMap();
        }, 100);

        // Update map when any location input changes
        const inputs = ['id_pickup_location', 'id_dropoff_location'];
        inputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                // Update on input (real-time)
                input.addEventListener('input', function() {
                    const query = this.value.trim();
                    if (query && query.length > 3) {
                        const mapDiv = document.getElementById('location-picker-map');
                        if (mapDiv) {
                            const embedUrl = `https://www.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
                            mapDiv.innerHTML = `<iframe width="100%" height="400" style="border:0; border-radius: 8px;" loading="lazy" allowfullscreen="" referrerpolicy="no-referrer-when-downgrade" src="${embedUrl}"></iframe>`;
                        }
                    }
                });
                
                // Also update on blur (when user finishes typing)
                input.addEventListener('blur', function() {
                    const query = this.value.trim();
                    if (query) {
                        const mapDiv = document.getElementById('location-picker-map');
                        if (mapDiv) {
                            const embedUrl = `https://www.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
                            mapDiv.innerHTML = `<iframe width="100%" height="400" style="border:0; border-radius: 8px;" loading="lazy" allowfullscreen="" referrerpolicy="no-referrer-when-downgrade" src="${embedUrl}"></iframe>`;
                        }
                    }
                });
            }
        });
    });
</script>
{% endblock %}


# --- EDU-MANAGE OPTIMIZED CPANEL CONFIG ---
RewriteEngine On
RewriteBase /

# 1. SERVE PHYSICAL FILES IMMEDIATELY IF THEY EXIST
# This handles index.html, favicon.png, and anything in static/ or assets/
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# 2. STATIC FILE MAPPING (FOR VITE /STATIC/ BASE)
# Map /static/assets/foo.js -> assets/foo.js
# Map /static/foo.js -> foo.js
RewriteRule ^static/assets/(.*)$ assets/$1 [L,NC]
RewriteRule ^static/(.*)$ $1 [L,NC]

# 3. MIME TYPE SAFETY FOR STATIC ASSETS
# If it's a JS or CSS file and wasn't found above, return 404 instead of index.html
# This prevents the "Refused to apply style" MIME error
RewriteCond %{REQUEST_URI} \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|json|webmanifest)$ [NC]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ - [R=404,L]

# 4. ROUTE API/ADMIN/MEDIA TO DJANGO (PASSENGER)
RewriteCond %{REQUEST_URI} ^/(api|admin|media)
RewriteRule ^(.*)$ passenger_wsgi.py/$1 [QSA,L]

# 5. ROUTE EVERYTHING ELSE TO REACT (index.html)
# Try mapping to index.html in current directory
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ index.html [L]

# 6. BROWSER CACHING (EXPIRES HEADERS)
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    
    # Images
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    
    # CSS / JS
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/x-javascript "access plus 1 year"
    
    # Fonts
    ExpiresByType font/truetype "access plus 1 year"
    ExpiresByType font/opentype "access plus 1 year"
    ExpiresByType application/x-font-woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
</IfModule>

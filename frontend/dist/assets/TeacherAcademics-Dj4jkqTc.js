import{f as B,u as G,k as K,r as l,j as e,A as W,m as S,e as h}from"./vendor-Cr6tcs86.js";import{I as X,B as $}from"./index-41VSs_U4.js";import{ah as Y,l as _,w as q,af as C,h as H,X as J,U as Q,O as V,a7 as Z}from"./ui-BBn2VFCU.js";const ne=()=>{const b=B();G();const{id:E}=K(),[ee,te]=l.useState("record"),[A,x]=l.useState(!1),[se,P]=l.useState(null),[f,O]=l.useState([]),[T,M]=l.useState([]),[r,u]=l.useState({grade_id:"",term:"1",type:"mid-term",date:new Date().toISOString().split("T")[0]}),[p,j]=l.useState(null),[g,y]=l.useState({}),[o,n]=l.useState(null),[R,z]=l.useState(!1);l.useEffect(()=>{(async()=>{try{const s=await h.get(`/api/teachers/${E}/`);P(s.data.teacher),s.data.teacher.professional.is_class_teacher&&s.data.teacher.professional.grade_id&&u(a=>({...a,grade_id:s.data.teacher.professional.grade_id}))}catch(s){console.error("Failed to load teacher data",s)}})()},[E]),l.useEffect(()=>{(async()=>{try{const s=await h.get("/api/subjects/");O(s.data.subjects||[])}catch(s){console.error("Failed to load metadata",s)}})()},[]),l.useEffect(()=>{const t=new URLSearchParams(b.search);t.get("student");const s=t.get("grade"),a=t.get("term"),d=t.get("type");s&&u(i=>({...i,grade_id:s,term:a||i.term,type:d||i.type}))},[b.search]),l.useEffect(()=>{if(!r.grade_id)return;M([]),(async()=>{x(!0);try{const s=await h.get(`/api/students/?grade=${r.grade_id}&per_page=1000`),a=s.data.students||s.data.results||[];M(a);const i=new URLSearchParams(b.search).get("student");if(i){const m=a.find(N=>N.id===parseInt(i));m&&F(m,a)}}catch(s){console.error("Failed to load students",s)}finally{x(!1)}})()},[r.grade_id]);const I=(t,s)=>{if(s===""){y(a=>({...a,[t]:""}));return}y(a=>({...a,[t]:s}))},D=t=>{const s=parseFloat(t);return isNaN(s)?{label:"-",class:""}:s>=80?{label:"EE",class:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"}:s>=60?{label:"ME",class:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400"}:s>=40?{label:"AE",class:"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400"}:{label:"BE",class:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"}},F=async t=>{if(j(t),y({}),n(null),z(!1),new URLSearchParams(b.search).get("edit")==="true"){console.log("Loading existing marks for editing...");try{const d=await h.get(`/api/students/${t.id}/academics/`);if(d.data.success&&d.data.records){const i=`Term ${r.term}`,m=d.data.records[i];if(m&&m[r.type]){const N=m[r.type],k={};N.subjects.forEach(v=>{const L=f.find(w=>w.name===v.subject_name||w.code===v.subject_code||w.name.toLowerCase()===v.subject_name.toLowerCase());L&&(k[L.id]=v.marks)}),Object.keys(k).length>0?(y(k),z(!0),n({type:"info",text:`Editing existing assessment. Loaded ${Object.keys(k).length} subject marks.`})):n({type:"error",text:"Could not load existing marks. Subject mismatch detected."})}else n({type:"error",text:`No existing ${r.type} assessment found for Term ${r.term}.`})}}catch(d){console.error("Error fetching existing marks:",d),n({type:"error",text:"Failed to load existing marks. Please try again."})}}},U=async()=>{if(!p||!r.grade_id)return;x(!0),n(null);const t=Object.entries(g).map(([a,d])=>({subject_id:a,marks:d})).filter(a=>a.marks!=="");if(t.length===0){n({type:"error",text:"Please enter at least one mark."}),x(!1);return}const s={student_id:p.id,grade_id:r.grade_id,term:r.term,assessment_type:r.type,date:r.date,results:t};try{const a=await h.post("/api/assessments/batch-save/",s);a.data.success&&(n({type:"success",text:`Saved ${a.data.saved_count} scores for ${p.full_name}!`}),setTimeout(()=>j(null),1500))}catch(a){console.error(a),n({type:"error",text:"Failed to save results. Please try again."})}finally{x(!1)}},c=(()=>{const t=Object.values(g).map(a=>parseFloat(a)).filter(a=>!isNaN(a));if(t.length===0)return{total:0,average:0,count:0};const s=t.reduce((a,d)=>a+d,0);return{total:s,average:(s/t.length).toFixed(1),count:t.length}})();return e.jsxs("div",{className:"p-4 md:p-8 max-w-7xl mx-auto space-y-6 md:space-y-8 pb-20",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-end justify-between gap-4 md:gap-6 pb-6 border-b border-slate-200 dark:border-slate-800",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-slate-900 dark:text-white tracking-tight",children:"Record Assessment"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 mt-1 md:mt-2 text-sm md:text-base",children:"Record marks for your students"})]})}),e.jsxs("div",{className:"bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 flex flex-col md:flex-row flex-wrap gap-4 items-stretch md:items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-slate-500 dark:text-slate-400 md:mr-2 mb-2 md:mb-0",children:[e.jsx(Y,{size:20}),e.jsx("span",{className:"font-medium text-sm",children:"Filters:"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:flex gap-3 w-full md:w-auto",children:[e.jsxs("div",{className:"relative w-full md:min-w-[180px]",children:[e.jsxs("select",{className:"w-full pl-4 pr-10 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-sm font-semibold focus:ring-2 focus:ring-primary-500 appearance-none text-slate-700 dark:text-slate-200",value:r.type,onChange:t=>u(s=>({...s,type:t.target.value})),children:[e.jsx("option",{value:"opener",children:"Opener Exam"}),e.jsx("option",{value:"mid-term",children:"Mid Term"}),e.jsx("option",{value:"end-term",children:"End Term"}),e.jsx("option",{value:"weekly",children:"Weekly Test"})]}),e.jsx(_,{size:16,className:"absolute right-3 top-3.5 text-slate-400 pointer-events-none"})]}),e.jsxs("div",{className:"relative w-full md:min-w-[140px]",children:[e.jsxs("select",{className:"w-full pl-4 pr-10 py-2.5 bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-sm font-semibold focus:ring-2 focus:ring-primary-500 appearance-none text-slate-700 dark:text-slate-200",value:r.term,onChange:t=>u(s=>({...s,term:t.target.value})),children:[e.jsx("option",{value:"1",children:"Term 1"}),e.jsx("option",{value:"2",children:"Term 2"}),e.jsx("option",{value:"3",children:"Term 3"})]}),e.jsx(_,{size:16,className:"absolute right-3 top-3.5 text-slate-400 pointer-events-none"})]})]}),e.jsx("div",{className:"w-full md:w-auto md:ml-auto",children:e.jsx(X,{type:"date",value:r.date,onChange:t=>u(s=>({...s,date:t.target.value})),className:"py-2.5 w-full md:w-auto"})})]}),e.jsx(W,{mode:"wait",children:o&&e.jsxs(S.div,{initial:{opacity:0,y:-20,height:0},animate:{opacity:1,y:0,height:"auto"},exit:{opacity:0,height:0},className:`px-4 py-3 rounded-lg flex items-center justify-between gap-4 ${o.type==="success"?"bg-green-50 text-green-700 border border-green-200 dark:bg-green-900/20 dark:border-green-800":o.type==="info"?"bg-blue-50 text-blue-700 border border-blue-200 dark:bg-blue-900/20 dark:border-blue-800":"bg-red-50 text-red-700 border border-red-200 dark:bg-red-900/20 dark:border-red-800"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[o.type==="success"?e.jsx(q,{size:18}):o.type==="info"?e.jsx(C,{size:18}):e.jsx(H,{size:18}),o.text]}),e.jsx("button",{onClick:()=>n(null),className:"opacity-50 hover:opacity-100 shrink-0",children:e.jsx(J,{size:16})})]})}),e.jsx(S.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.3},children:p?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsxs("div",{className:"lg:col-span-3 bg-white dark:bg-slate-900 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-800 overflow-hidden",children:[e.jsxs("div",{className:"p-4 md:p-6 border-b border-slate-100 dark:border-slate-800 flex flex-col md:flex-row justify-between items-start md:items-center bg-slate-50/50 dark:bg-slate-800/50 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3 w-full md:w-auto",children:[e.jsx("button",{onClick:()=>j(null),className:"p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors text-slate-500 shrink-0",children:e.jsx(_,{className:"rotate-90",size:24})}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h2",{className:"text-lg md:text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2 truncate",children:[e.jsx("span",{className:"truncate",children:p.full_name}),R&&e.jsx("span",{className:"px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-[10px] md:text-xs font-bold rounded-full uppercase tracking-wide shrink-0",children:"Edit Mode"})]}),e.jsxs("p",{className:"text-xs md:text-sm text-slate-500 mt-0.5 truncate",children:["Recording ",e.jsx("span",{className:"font-semibold text-primary-600",children:r.type})," for Term ",r.term]})]})]}),e.jsxs("div",{className:"flex gap-3 w-full md:w-auto pl-11 md:pl-0",children:[e.jsx($,{variant:"secondary",onClick:()=>j(null),className:"flex-1 md:flex-none justify-center",children:"Cancel"}),e.jsxs($,{onClick:U,isLoading:A,className:"flex-1 md:flex-none justify-center",children:[e.jsx(V,{size:18,className:"mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Save Grades"}),e.jsx("span",{className:"sm:hidden",children:"Save"})]})]})]}),e.jsx("div",{className:"p-4 md:p-6 lg:p-8",children:e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 md:gap-y-6",children:f.map(t=>{const s=D(g[t.id]);return e.jsxs("div",{className:"relative group",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("label",{className:"text-sm font-bold text-slate-700 dark:text-slate-300 truncate pr-2",children:t.name}),g[t.id]&&e.jsx("span",{className:`text-[10px] font-bold px-1.5 py-0.5 rounded ${s.class} shrink-0`,children:s.label})]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",max:"100",placeholder:"â€”",className:"w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 focus:ring-2 focus:ring-primary-500 focus:bg-white dark:focus:bg-slate-800 outline-none transition-all font-mono text-lg font-semibold text-center",value:g[t.id]||"",onChange:a=>I(t.id,a.target.value)}),e.jsx("div",{className:"absolute inset-y-0 right-3 flex items-center text-slate-400 text-xs font-bold pointer-events-none",children:"/100"})]})]},t.id)})})})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-2xl p-6 shadow-sm border border-slate-100 dark:border-slate-800 sticky top-6",children:[e.jsxs("h3",{className:"font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(Z,{className:"text-amber-500",size:20}),"Current Stats"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl",children:[e.jsx("p",{className:"text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1",children:"Subjects Graded"}),e.jsxs("p",{className:"text-2xl font-black text-slate-900 dark:text-white",children:[c.count," ",e.jsxs("span",{className:"text-sm font-medium text-slate-400",children:["/ ",f.length]})]}),e.jsx("div",{className:"w-full bg-slate-200 dark:bg-slate-700 h-1.5 rounded-full mt-2 overflow-hidden",children:e.jsx("div",{className:"bg-primary-500 h-full rounded-full transition-all duration-300",style:{width:`${c.count/f.length*100}%`}})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl text-center",children:[e.jsx("p",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Total"}),e.jsx("p",{className:"text-xl font-bold text-slate-900 dark:text-white",children:c.total})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl text-center",children:[e.jsx("p",{className:"text-xs font-semibold text-slate-500 uppercase mb-1",children:"Average"}),e.jsxs("p",{className:`text-xl font-bold ${parseFloat(c.average)>=60?"text-green-600":parseFloat(c.average)>=40?"text-amber-600":"text-slate-900 dark:text-white"}`,children:[c.average,"%"]})]})]})]}),e.jsx("div",{className:"mt-6 pt-6 border-t border-slate-100 dark:border-slate-800",children:e.jsx("p",{className:"text-xs text-slate-400 text-center",children:"System auto-calculates grade levels and totals upon saving."})})]})})]}):r.grade_id?e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:[T.map((t,s)=>e.jsxs(S.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:s*.03},onClick:()=>F(t),className:"bg-white dark:bg-slate-900 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md transition-all cursor-pointer group relative overflow-hidden flex sm:block items-center sm:items-start gap-4 sm:gap-0",children:[e.jsx("div",{className:"absolute top-0 right-0 p-4 opacity-0 group-hover:opacity-100 transition-opacity hidden sm:block",children:e.jsx("div",{className:"bg-primary-50 text-primary-600 rounded-full p-1",children:e.jsx(C,{size:14})})}),e.jsx("div",{className:"h-12 w-12 sm:mb-4 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-700 flex items-center justify-center text-lg font-bold text-slate-500 uppercase shrink-0",children:t.photo?e.jsx("img",{src:t.photo,alt:"Student",className:"w-full h-full object-cover rounded-xl"}):t.full_name?.[0]||"S"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-slate-900 dark:text-white group-hover:text-primary-600 transition-colors line-clamp-1 text-sm sm:text-base",children:t.full_name}),e.jsxs("p",{className:"text-xs font-medium text-slate-500 dark:text-slate-400 mt-0.5 sm:mt-1",children:["Adm: ",e.jsx("span",{className:"text-slate-700 dark:text-slate-300",children:t.admission_number})]}),e.jsx("div",{className:"mt-2 text-xs text-slate-400 hidden sm:flex items-center gap-1",children:"Click to record marks"})]}),e.jsx("div",{className:"ml-auto sm:hidden text-primary-500",children:e.jsx(C,{size:16})})]},t.id)),T.length===0&&e.jsx("div",{className:"col-span-full py-20 text-center text-slate-400 bg-slate-50 dark:bg-slate-900/50 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-800",children:"No students found in this class."})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 bg-slate-50 dark:bg-slate-900/50 rounded-3xl border-2 border-dashed border-slate-200 dark:border-slate-800",children:[e.jsx("div",{className:"h-16 w-16 bg-white dark:bg-slate-800 rounded-2xl flex items-center justify-center shadow-sm mb-4",children:e.jsx(Q,{size:32,className:"text-primary-500"})}),e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-white",children:"Loading Your Class"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 mt-1 max-w-sm text-center",children:"Please wait while we load your students..."})]})})]})};export{ne as default};
